language: cpp
sudo: required
compiler:
  - gcc
  - clang

services:
  - docker

install:
  # Pull Docker image
  - docker pull tatsy/ubuntu-cxx
  - docker build --tag=spica-env --quiet=true .

script:
  # Run test on Docker container
  - docker run --env="CC=$CC" --env="CXX=$CXX" tatsy/ubuntu-cxx /bin/bash -c "lcov --directory . --zerocounters && CTEST_OUTOUT_ON_FAILURE=TRUE make check"

after_success:
  # Send coverage report to Coveralls
  - docker run -t tatsy/ubuntu-cxx /bin/bash -c "if [ "$CXX" = "g++"     ]; then lcov --directory . --capture --output-file coverage.info; fi"
  - docker run -t tatsy/ubuntu-cxx /bin/bash -c "if [ "$CXX" = "clang++" ]; then lcov --directory . --capture --output-file coverage.info --gcov-tool llvm-cov-${LLVM_VER}; fi"
  - docker run -t tatsy/ubuntu-cxx /bin/bash -c "lcov --remove coverage.info '3rdparty/*' 'src/renderer/*' 'src/viewer/*' 'test/*' 'example/*' '/usr/*' 'CMakeFiles/*' --output-file coverage.info"
  - docker run -t tatsy/ubuntu-cxx /bin/bash -c "lcov --list coverage.info"
  - docker run -t tatsy/ubuntu-cxx /bin/bash -c "coveralls-lcov --repo-token RiYcPJSCbPZoogMd1PE10696EAqG8sl5q coverage.info"

branches:
  only:
    - master
    - develop

notifications:
  email:
    recipients: tatsy.mail@gmail.com
    on_success: change
    on_failure: always

env:
  global:
    - LLVM_VER='3.7'
